Sub GenerateMarsho()
    Dim filePath As String
    Dim targetDate As Date, targetDay As Integer
    Dim wsTarget As Worksheet
    Dim startRow As Long
    Dim wb As Workbook
    Dim ws As Worksheet
    Dim wsFill As Worksheet


    ' Tentukan tanggal proses (kemarin)
    targetDate = Date - 1
    targetDay = Day(targetDate)
    
    ' Ambil file dari email hari ini
    filePath = GetAttachment_BIO()
    Debug.Print "File path: "; filePath
    If filePath = "" Then
        MsgBox "File BIO tidak ditemukan dari email hari ini.", vbExclamation
        Exit Sub
    End If
    
    ' Pastikan sheet output ada
    On Error Resume Next
    Set wsTarget = ThisWorkbook.Sheets(Format(targetDate, "dd"))
    If wsTarget Is Nothing Then
        Set wsTarget = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
        wsTarget.Name = Format(targetDate, "dd")
    End If
    On Error GoTo 0
    
    ' Bersihkan area lama
    wsTarget.Cells.Clear
    
    ' Baris mulai output
    startRow = 1
    
    ' --- Buka workbook sumber ---
    Set wb = Workbooks.Open(filePath)
    
    ' --- Jalankan Marsho ---
    On Error Resume Next
    Set ws = wb.Sheets("Marunda-Marsho")
    On Error GoTo 0
    If Not ws Is Nothing Then
        GenerateMarshoPlantReport ws, wsTarget, targetDate, startRow
    Else
        wsTarget.Cells(startRow, 1).Value = "Sheet 'Marunda-Marsho' tidak ditemukan."
        startRow = startRow + 2
    End If
    
    ' --- Jalankan Filling ---
    On Error Resume Next
    Set wsFill = wb.Sheets("Marunda-Oil")
    On Error GoTo 0
    If Not wsFill Is Nothing Then
        GenerateFillingPlantReport wsFill, wsTarget, targetDate, startRow
    Else
        wsTarget.Cells(startRow, 1).Value = "Sheet 'Marunda-Oil' tidak ditemukan."
        startRow = startRow + 2
    End If
    
    ' Tutup workbook sumber
    wb.Close False

    MsgBox "? Laporan aktual planning untuk tanggal " & Format(targetDate, "dd MMM yyyy") & " berhasil dibuat!", vbInformation
End Sub

Function GetAttachment_BIO() As String
    Dim olApp As Object, olNs As Object, olFolder As Object
    Dim olItems As Object, olMail As Object, olAtmt As Object
    Dim baseName As String, savePath As String
    Dim i As Long
    Dim todayDate As Date
    
    todayDate = Date
    
    baseName = "08. Actual vs Planning Agustus Marunda (2025) 1.xlsx"
    savePath = Environ("TEMP") & "\BIO_" & Format(todayDate, "yyyymmdd") & ".xlsx"
    
    ' kalau file sudah ada ? hapus dulu supaya bisa replace
    If Dir(savePath) <> "" Then
        Kill savePath
    End If
    
    ' --- ambil email hari ini ---
    Set olApp = CreateObject("Outlook.Application")
    Set olNs = olApp.GetNamespace("MAPI")
    Set olFolder = olNs.GetDefaultFolder(6) 'Inbox
    Set olItems = olFolder.Items
    olItems.Sort "[ReceivedTime]", True
    
    For i = 1 To olItems.Count
        Set olMail = olItems.Item(i)
        If olMail.Class = 43 Then ' olMailItem
            If Int(olMail.ReceivedTime) = todayDate Then
                If InStr(1, olMail.senderName, "Jessica Silvera", vbTextCompare) > 0 Or _
                   InStr(1, olMail.senderName, "Wendy Fadillah Nugraha", vbTextCompare) > 0 Then
                    For Each olAtmt In olMail.Attachments
                        If olAtmt.Filename = baseName Then
                            olAtmt.SaveAsFile savePath
                            GetAttachment_BIO = savePath
                            Exit Function
                        End If
                    Next olAtmt
                End If
            End If
        End If
    Next i
    
    GetAttachment_BIO = ""
End Function

Sub GenerateFillingPlantReport(ws As Worksheet, wsTarget As Worksheet, targetDate As Date, ByRef row As Long)
    Dim col As Long, lastCol As Long
    Dim dataCol As Long
    Dim found As Boolean
    Dim targetText As String
    Dim planValue As Variant, actualValue As Variant, perfValue As Variant
    Dim curRow As Long, lastRow As Long
    Dim machineName As String
    Dim validMachines As Variant, m As Variant
    Dim cellVal As String
    Dim cellComment As String
    
    ' --- tambahan variabel untuk running, total, dan tracking eff terendah ---
    Dim runningCount As Long, totalMachines As Long
    Dim totalPlan As Double, totalActual As Double
    Dim minPerf As Double, minMachine As String, minComment As String
    
    ' --- tambahan variabel khusus summary baru ---
    Dim thimPlan As Double, thimActual As Double, thimDowntime As String
    Dim otherPlan As Double, otherActual As Double, otherDowntime As String
    
    ' --- daftar mesin Filling Plant ---
        ' --- daftar mesin Filling Plant ---
        validMachines = Array("Thimonier 1", "Thimonier 2", "Thimonier 3", "Thimonier 5 (ASRS)", _
                              "Thimonier 7", "Thimonier 9", "Thimonier 10", "Emec - 2L -5L", _
                              "Emec - 18L (16 Nozzle)", "Emec -  BIB 18 L (I)", "Emec -  BIB 18 L (II)", _
                              "Emec -  BIB 18 L (III)", "SERAC")
        
' Hitung total mesin Thimmonier

totalMachines = 0
For Each m In validMachines
    If InStr(1, m, "Thimonier", vbTextCompare) > 0 Then
        totalMachines = totalMachines + 1
    End If
Next m
    
    minPerf = 999999
    thimPlan = 0: thimActual = 0: thimDowntime = ""
    otherPlan = 0: otherActual = 0: otherDowntime = ""
    
    ' --- format tanggal target ---
    targetText = Format(targetDate, "d - mmm")
    
    ' --- cari kolom tanggal di baris 5 ---
    lastCol = ws.Cells(5, ws.Columns.Count).End(xlToLeft).Column
    found = False
    For col = 1 To lastCol
        If Trim(ws.Cells(5, col).Text) = targetText Then
            dataCol = col
            found = True
            Exit For
        End If
    Next col
    
    If Not found Then
        wsTarget.Cells(row, 1).Value = "Filling Plant - Tanggal tidak ditemukan (" & targetText & ")"
        row = row + 2
        Exit Sub
    End If
    
    ' --- header detail ---
    wsTarget.Cells(row, 1).Value = "Filling Plant (" & targetText & ")"
    row = row + 1
    wsTarget.Cells(row, 1).Value = "Mesin"
    wsTarget.Cells(row, 2).Value = "Plan"
    wsTarget.Cells(row, 3).Value = "Actual"
    wsTarget.Cells(row, 4).Value = "Performance (%)"
    wsTarget.Cells(row, 5).Value = "Comment"
    row = row + 1
    
    machineName = ""
    curRow = 6
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).row
    
    ' --- loop baris sampai akhir sheet ---
    Do While curRow <= lastRow
        cellVal = Trim(ws.Cells(curRow, 1).MergeArea.Cells(1, 1).Text)
        
        ' cek apakah baris ini nama mesin valid
        For Each m In validMachines
            If StrComp(cellVal, m, vbTextCompare) = 0 Then
                machineName = m
                Exit For
            End If
        Next m
        
        ' kalau baris ini adalah "IN TONASE" dan ada mesin aktif
        If Trim(UCase(cellVal)) = "IN TONASE" And machineName <> "" Then
            planValue = RoundNormal(CDbl(ws.Cells(curRow, dataCol).Value), 2)
            actualValue = RoundNormal(CDbl(ws.Cells(curRow, dataCol + 1).Value), 2)
            
            ' hitung performance
            If planValue <> 0 Then
                perfValue = Round((actualValue / planValue) * 100, 2)
            Else
                perfValue = 0
            End If
            
            ' --- ambil comment ---
            cellComment = ""
            Dim r As Long
            If perfValue <= 100 Then
                r = curRow - 1
                Do While r > 1
                    If StrComp(Trim(ws.Cells(r, 1).MergeArea.Cells(1, 1).Text), machineName, vbTextCompare) = 0 Then
                        Exit Do
                    End If
                    If Not ws.Cells(r, dataCol + 1).Comment Is Nothing Then
                        Dim fullComment As String, words() As String
                        fullComment = Trim(ws.Cells(r, dataCol + 1).Comment.Text)
                        words = Split(fullComment, " ")
                        If UBound(words) <= 2 Then
                            If cellComment <> "" Then cellComment = cellComment & "; "
                            cellComment = cellComment & fullComment
                        End If
                    End If
                    r = r - 1
                Loop
            End If
            
            ' tulis detail ke target sheet
            wsTarget.Cells(row, 1).Value = machineName
            wsTarget.Cells(row, 2).Value = planValue
            wsTarget.Cells(row, 3).Value = actualValue
            wsTarget.Cells(row, 4).Value = perfValue
            wsTarget.Cells(row, 4).NumberFormat = "0.00""%"""
            wsTarget.Cells(row, 5).Value = cellComment
            
            ' hitung running dan total
' hitung runningCount (khusus Thimmonier)
If InStr(1, machineName, "Thimonier", vbTextCompare) > 0 Then
    If actualValue > 0 Then runningCount = runningCount + 1
End If
            
            ' cek perf minimum
            If perfValue > 0 And perfValue < minPerf Then
                minPerf = perfValue
                minMachine = machineName
                minComment = cellComment
            End If
            
            ' pisahkan Thimmonier vs Others
            If InStr(1, machineName, "Thimonier", vbTextCompare) > 0 Then
                thimPlan = thimPlan + planValue
                thimActual = thimActual + actualValue
                If thimDowntime = "" And cellComment <> "" Then thimDowntime = cellComment
            Else
                otherPlan = otherPlan + planValue
                otherActual = otherActual + actualValue
                If otherDowntime = "" And cellComment <> "" Then otherDowntime = cellComment
            End If
            
            row = row + 1
            machineName = ""
        End If
        
        curRow = curRow + 1
    Loop
    
    row = row + 1
    
    ' --- summary baru ---
    wsTarget.Cells(row, 1).Value = "FILLING PLANT"
    row = row + 1
wsTarget.Cells(row, 1).Value = "Run " & runningCount & " of " & totalMachines & " Thimmonier Machine"
    row = row + 1
    
    wsTarget.Cells(row, 1).Value = "Thim Plan/Actual : " & _
                                   Format(Round(thimPlan, 0), "0") & "/" & _
                                   Format(Round(thimActual, 0), "0") & " Ton"
    row = row + 1
    wsTarget.Cells(row, 1).Value = "downtime: " & IIf(thimDowntime = "", "none", thimDowntime)
    row = row + 1
    
    wsTarget.Cells(row, 1).Value = "Others Plan/Actual: " & _
                                   Format(Round(otherPlan, 0), "0") & "/" & _
                                   Format(Round(otherActual, 0), "0") & " Ton"
    row = row + 1
    wsTarget.Cells(row, 1).Value = "downtime: " & IIf(otherDowntime = "", "none", otherDowntime)
    row = row + 2
End Sub



Sub GenerateMarshoPlantReport(ws As Worksheet, wsTarget As Worksheet, targetDate As Date, ByRef row As Long)
    Dim col As Long, lastCol As Long
    Dim dataCol As Long
    Dim found As Boolean
    Dim targetText As String
    Dim planValue As Variant, actualValue As Variant, perfValue As Variant
    Dim curRow As Long, lastRow As Long
    Dim machineName As String
    Dim validMachines As Variant, m As Variant
    Dim cellVal As String
    Dim cellComment As String
    
    ' --- tambahan variabel untuk running, total, dan tracking eff terendah ---
    Dim runningCount As Long, totalMachines As Long
    Dim totalPlan As Double, totalActual As Double
    Dim minPerf As Double, minMachine As String, minComment As String
    
    ' --- daftar mesin yang diambil ---
    validMachines = Array("UGS I", "Chemtech", "Chemtech 2", "UGS 6", "UGS II", "UGS III", "UGS V")
    totalMachines = UBound(validMachines) - LBound(validMachines) + 1
    
    minPerf = 999999    ' nilai awal besar supaya bisa dibanding
    
    ' --- format tanggal target ---
    targetText = Format(targetDate, "d - mmm")
    
    ' --- cari kolom tanggal di baris 5 ---
    lastCol = ws.Cells(5, ws.Columns.Count).End(xlToLeft).Column
    found = False
    For col = 1 To lastCol
        If Trim(ws.Cells(5, col).Text) = targetText Then
            dataCol = col
            found = True
            Exit For
        End If
    Next col
    
    If Not found Then
        wsTarget.Cells(row, 1).Value = "Marsho Plant - Tanggal tidak ditemukan (" & targetText & ")"
        row = row + 2
        Exit Sub
    End If
    
    ' --- judul & header ---
    wsTarget.Cells(row, 1).Value = "Marsho Plant (" & targetText & ")"
    row = row + 1
    wsTarget.Cells(row, 1).Value = "Mesin"
    wsTarget.Cells(row, 2).Value = "Plan"
    wsTarget.Cells(row, 3).Value = "Actual"
    wsTarget.Cells(row, 4).Value = "Performance (%)"
    wsTarget.Cells(row, 5).Value = "Comment"
    row = row + 1
    
    machineName = ""
    curRow = 6
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).row
    
    ' --- loop baris sampai akhir sheet ---
    Do While curRow <= lastRow
        cellVal = Trim(ws.Cells(curRow, 1).MergeArea.Cells(1, 1).Text)
        
        ' kalau baris ini adalah nama mesin valid
        For Each m In validMachines
            If StrComp(cellVal, m, vbTextCompare) = 0 Then
                machineName = m
                Exit For
            End If
        Next m

        ' kalau baris ini adalah "IN TONASE" dan ada mesin aktif
        If Trim(UCase(cellVal)) = "IN TONASE" And machineName <> "" Then
            planValue = RoundNormal(CDbl(ws.Cells(curRow, dataCol).Value), 2)
            actualValue = RoundNormal(CDbl(ws.Cells(curRow, dataCol + 1).Value), 2)
            
            ' hitung performance (%)
            If planValue <> 0 Then
                perfValue = Round((actualValue / planValue) * 100, 2)
            Else
                perfValue = 0
            End If
            
            ' --- ambil comment dari baris produk (di antara nama mesin dan IN TONASE) ---
            cellComment = ""
            Dim r As Long
            If perfValue <= 100 Then
                r = curRow - 1
                Do While r > 1
                    If StrComp(Trim(ws.Cells(r, 1).MergeArea.Cells(1, 1).Text), machineName, vbTextCompare) = 0 Then
                        Exit Do
                    End If
                    If Not ws.Cells(r, dataCol + 1).Comment Is Nothing Then
                        Dim fullComment As String, words() As String
                        fullComment = Trim(ws.Cells(r, dataCol + 1).Comment.Text)
                        words = Split(fullComment, " ")
                        If UBound(words) <= 6 Then   ' max 6 kata
                            If cellComment <> "" Then cellComment = cellComment & "; "
                            cellComment = cellComment & fullComment
                        End If
                    End If
                    r = r - 1
                Loop
            End If
            
            ' tulis ke target
            wsTarget.Cells(row, 1).Value = machineName
            wsTarget.Cells(row, 2).Value = planValue
            wsTarget.Cells(row, 3).Value = actualValue
            wsTarget.Cells(row, 4).Value = perfValue
            wsTarget.Cells(row, 4).NumberFormat = "0.00""%"""
            wsTarget.Cells(row, 5).Value = cellComment
            
            ' hitung running dan total
            If actualValue > 0 Then runningCount = runningCount + 1
            totalPlan = totalPlan + planValue
            totalActual = totalActual + actualValue
            
            ' --- cek minimum perf (exclude 0) ---
            If perfValue > 0 And perfValue < minPerf Then
                minPerf = perfValue
                minMachine = machineName
                minComment = cellComment
            End If
            
            row = row + 1
            machineName = ""
        End If
        
        curRow = curRow + 1
    Loop
       row = row + 1
    
    ' --- summary running dan total ---
    wsTarget.Cells(row, 1).Value = "Marsho Plant"
    row = row + 1
    wsTarget.Cells(row, 1).Value = "Running " & runningCount & " dari " & totalMachines & " Machine"
    row = row + 1
    wsTarget.Cells(row, 1).Value = "Plan vs Actual = " & _
                                   Format(Round(totalPlan, 0), "0") & " / " & _
                                   Format(Round(totalActual, 0), "0") & " Ton"
    row = row + 1
    
    ' --- tampilkan eff terendah ---
    If minPerf < 999999 Then
        wsTarget.Cells(row, 1).Value = "eff " & minMachine & ", " & _
                                       Format(minPerf, "0.00") & "%, " & minComment
        row = row + 2
    Else
        row = row + 2
    End If
End Sub



Function RoundNormal(ByVal x As Double, Optional digits As Long = 0) As Double
    RoundNormal = Round(x, digits)
End Function






