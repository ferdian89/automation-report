Sub GenerateRefineryReportCombined()

    ' Jalankan dua kali untuk Ref 1 dan Ref 2, ditulis ke satu sheet
    Dim sheetName As String
    sheetName = CStr(Day(Date - 1)) ' Misalnya: 23
    Dim wsTarget As Worksheet

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' Siapkan atau buat sheet target
    On Error Resume Next
    Set wsTarget = ThisWorkbook.Sheets(sheetName)
    If wsTarget Is Nothing Then
        Set wsTarget = ThisWorkbook.Sheets.Add(After:=Sheets(Sheets.Count))
        wsTarget.Name = sheetName
    Else
        wsTarget.Cells.Clear
    End If
    On Error GoTo 0

    ' Jalankan laporan Ref 1 (mulai dari baris 1)
    Dim nextRow As Long
    nextRow = 1
    nextRow = GenerateRefinedReportSingle("Ref 1", wsTarget, nextRow)

    ' Sisipkan 1 baris kosong
    nextRow = nextRow + 1

    ' Jalankan laporan Ref 2 (lanjut dari nextRow)
    Call GenerateRefinedReportSingle("Ref 2", wsTarget, nextRow)

    MsgBox "Laporan refinery untuk tanggal " & sheetName & " selesai dibuat.", vbInformation
    Application.ScreenUpdating = True

End Sub

Function GenerateRefinedReportSingle(sheetSourceName As String, wsTarget As Worksheet, startRow As Long) As Long

    Const PARAM_ROW_H1 As Long = 8
    Const PARAM_ROW_H2 As Long = 9

    Dim sourceFilePath As String
    Dim sourceWorkbook As Workbook, wsSource As Worksheet
    Dim todayDay As Integer
    Dim i As Long, lastRow As Long
    Dim cell As Range, mergeVal As Variant
    Dim matchingRows As Collection
    Dim r As Variant

    todayDay = Day(Date - 1)

    sourceFilePath = "Z:\Document Share (Marunda All)\Process Engineering\summary act vs budget\Refinery and Fractination Production Report Juli 2025  (HO) Flowmeter.xlsx"

    ' Buka file sumber
    On Error Resume Next
    Set sourceWorkbook = Workbooks.Open(sourceFilePath, ReadOnly:=True)
    If sourceWorkbook Is Nothing Then
        MsgBox "File tidak ditemukan: " & sourceFilePath, vbCritical
        Exit Function
    End If
    Set wsSource = sourceWorkbook.Sheets(sheetSourceName)
    On Error GoTo 0

    ' Cari baris yang cocok dengan tanggal
    Set matchingRows = New Collection
    lastRow = wsSource.Cells(wsSource.Rows.Count, "A").End(xlUp).row
    For i = 10 To lastRow
        Set cell = wsSource.Cells(i, 1)
        mergeVal = IIf(cell.MergeCells, cell.MergeArea.Cells(1, 1).value, cell.value)
        If mergeVal = todayDay Then matchingRows.Add i
    Next i

    If matchingRows.Count = 0 Then
        MsgBox "Tanggal " & todayDay & " tidak ditemukan di " & sheetSourceName, vbExclamation
        sourceWorkbook.Close False
        Exit Function
    End If

    ' Hitung total dan bobot
    Dim totalCPOKg As Double, totalRBDPOKg As Double, totalPFADKg As Double
    Dim weightedSteam As Double, weightedElectricity As Double
    Dim weightedBE As Double, weightedPA As Double
    Dim weightedCPOFFA As Double, weightedRBDPOFFA As Double
    Dim weightedRBDPOCol As Double, weightedPFADPurity As Double
    Dim rowCPO As Double

    For Each r In matchingRows
        rowCPO = GetCellVal(wsSource, CLng(r), "input", "kg", PARAM_ROW_H1, PARAM_ROW_H2)
        totalCPOKg = totalCPOKg + rowCPO
        totalRBDPOKg = totalRBDPOKg + GetCellVal(wsSource, CLng(r), "rbd output", "kg", PARAM_ROW_H1, PARAM_ROW_H2)
        totalPFADKg = totalPFADKg + GetCellVal(wsSource, CLng(r), "pfad output", "kg", PARAM_ROW_H1, PARAM_ROW_H2)

        weightedSteam = weightedSteam + rowCPO * GetCellVal(wsSource, CLng(r), "steam", "kg/mt", PARAM_ROW_H1, PARAM_ROW_H2)
        weightedElectricity = weightedElectricity + rowCPO * GetCellVal(wsSource, CLng(r), "electricity", "kwh/mt", PARAM_ROW_H1, PARAM_ROW_H2)
        weightedBE = weightedBE + rowCPO * GetCellVal(wsSource, CLng(r), "bleaching earth", "%", PARAM_ROW_H1, PARAM_ROW_H2)
        weightedPA = weightedPA + rowCPO * GetCellVal(wsSource, CLng(r), "phosphoric acid", "%", PARAM_ROW_H1, PARAM_ROW_H2)
        weightedCPOFFA = weightedCPOFFA + rowCPO * GetCellVal(wsSource, CLng(r), "input", "ffa", PARAM_ROW_H1, PARAM_ROW_H2)
        weightedRBDPOFFA = weightedRBDPOFFA + rowCPO * GetCellVal(wsSource, CLng(r), "rbd output", "%ffa", PARAM_ROW_H1, PARAM_ROW_H2)
        weightedRBDPOCol = weightedRBDPOCol + rowCPO * GetCellVal(wsSource, CLng(r), "rbd output", "col", PARAM_ROW_H1, PARAM_ROW_H2)
        weightedPFADPurity = weightedPFADPurity + rowCPO * GetCellVal(wsSource, CLng(r), "pfad output", "%ffa", PARAM_ROW_H1, PARAM_ROW_H2)
    Next r

    sourceWorkbook.Close False

    ' Hitung akhir
    Dim cpoMT As Long, rbdpoMT As Long, pfadMT As Long
    Dim rbdpoPct As Double, pfadPct As Double
    cpoMT = Round(totalCPOKg / 1000)
    rbdpoMT = Round(totalRBDPOKg / 1000)
    pfadMT = Round(totalPFADKg / 1000)

    If totalCPOKg > 0 Then
        rbdpoPct = totalRBDPOKg / totalCPOKg * 100
        pfadPct = totalPFADKg / totalCPOKg * 100
    End If

    ' Tulis ke sheet target
    Dim row As Long: row = startRow
    With wsTarget
        .Cells(row, 1).value = IIf(sheetSourceName = "Ref 1", "REFINERY PLANT 1", "REFINERY PLANT 2"): row = row + 1
        .Cells(row, 1).value = "Quantity": row = row + 1
        .Cells(row, 1).value = "CPO process : " & cpoMT & " MT": row = row + 1
        .Cells(row, 1).value = "RBDPO : " & rbdpoMT & " MT (" & Format(rbdpoPct, "0.00") & " %)": row = row + 1
        .Cells(row, 1).value = "PFAD : " & pfadMT & " MT (" & Format(pfadPct, "0.00") & " %)": row = row + 1
        .Cells(row, 1).value = "Consumption": row = row + 1
        .Cells(row, 1).value = "Steam : " & Round(weightedSteam / totalCPOKg) & " kg/MT": row = row + 1
        .Cells(row, 1).value = "Elect : " & Round(weightedElectricity / totalCPOKg) & " kWh/MT": row = row + 1
        .Cells(row, 1).value = "BE : " & Format(weightedBE / totalCPOKg, "0.00") & " %": row = row + 1
        .Cells(row, 1).value = "PA : " & Format(weightedPA / totalCPOKg, "0.00") & " %": row = row + 1
        .Cells(row, 1).value = "Quality": row = row + 1
        .Cells(row, 1).value = "CPO FFA : " & Format(weightedCPOFFA / totalCPOKg, "0.00") & " %": row = row + 1
        .Cells(row, 1).value = "RBDPO FFA : " & Format(weightedRBDPOFFA / totalCPOKg, "0.00") & " %": row = row + 1
        .Cells(row, 1).value = "Color RBDPO : " & Format(weightedRBDPOCol / totalCPOKg, "0.0"): row = row + 1
        .Cells(row, 1).value = "PFAD purity : " & Format(weightedPFADPurity / totalCPOKg, "0.00") & " %"
    End With

    GenerateRefinedReportSingle = row + 1 ' Kembalikan baris terakhir
End Function

Private Function GetCellVal(ws As Worksheet, row As Long, h1Text As String, h2Text As String, h1Row As Long, h2Row As Long) As Double
    Dim lastCol As Long, col As Long
    Dim h1 As String, h2 As String

    lastCol = ws.Cells(h1Row, ws.Columns.Count).End(xlToLeft).Column

    For col = 2 To lastCol
        h1 = LCase(Trim(ws.Cells(h1Row, col).MergeArea.Cells(1, 1).value))
        h2 = LCase(Trim(ws.Cells(h2Row, col).value))
        If h1 = LCase(h1Text) And h2 = LCase(h2Text) Then
            If IsNumeric(ws.Cells(row, col).value) Then
                GetCellVal = ws.Cells(row, col).value
            Else
                GetCellVal = 0
            End If
            Exit Function
        End If
    Next col

    GetCellVal = 0
End Function

