Function GetAttachment_FillingGly(Optional targetDay As Date) As String
    Dim olApp As Object, olNs As Object, olFolder As Object
    Dim olItems As Object, olMail As Object, olAtmt As Object
    Dim fileName As String, savePath As String
    
    fileName = "Daily Report Production Filling Glycerin Plant August 2025.xlsx"
    savePath = Environ("TEMP") & "\" & fileName
    If targetDay = 0 Then targetDay = Date
    
    Debug.Print "=== LOG GetAttachment_FillingGly ==="
    Debug.Print "Target Date : " & Format(targetDay, "dd-mmm-yyyy")
    Debug.Print "Save Path   : " & savePath
    
    ' Pastikan Outlook aktif
    On Error Resume Next
    Set olApp = GetObject(, "Outlook.Application")
    On Error GoTo 0
    If olApp Is Nothing Then
        Debug.Print "ERROR: Outlook tidak terbuka!"
        Exit Function
    End If
    
    Set olNs = olApp.GetNamespace("MAPI")
    Set olFolder = olNs.GetDefaultFolder(6) ' Inbox
    Set olItems = olFolder.Items
    olItems.Sort "ReceivedTime", True
    
    For Each olMail In olItems
        If TypeName(olMail) = "MailItem" Then
            If Int(olMail.ReceivedTime) = Int(targetDay) Then
                Debug.Print "Cek Mail: " & olMail.SenderName & " | " & olMail.Subject
                
                If (InStr(1, olMail.SenderName, "Hani Wulandari", vbTextCompare) > 0) _
                Or (InStr(1, olMail.SenderName, "Wendy Fadillah Nugraha", vbTextCompare) > 0) Then
                    
                    Debug.Print ">> Email pengirim sesuai kriteria"
                    
                    For Each olAtmt In olMail.Attachments
                        Debug.Print "   - Attachment: " & olAtmt.fileName
                        
                        ' Pencocokan fleksibel nama file
                        If InStr(1, olAtmt.fileName, "Filling Glycerin", vbTextCompare) > 0 Then
                            Debug.Print ">> Cocok! Simpan ke: " & savePath
                            
                            ' Hapus file lama kalau ada
                            On Error Resume Next
                            Kill savePath
                            On Error GoTo 0
                            
                            ' Simpan attachment
                            olAtmt.SaveAsFile savePath
                            GetAttachment_FillingGly = savePath
                            
                            Debug.Print "SUCCESS: Attachment disimpan!"
                            Exit Function
                        End If
                    Next
                End If
            End If
        End If
    Next
    
    ' Kalau tidak ketemu
    Debug.Print "WARNING: Attachment tidak ditemukan."
    GetAttachment_FillingGly = ""
End Function



' ====================================================
' Sub Utama: GetFillingGlycerine (versi normal)
' ====================================================
Sub GetFillingGlycerine()
    On Error GoTo ErrHandler
    
    Dim tempFile As String
    Dim xlApp As Object, xlWb As Object, xlWs As Object
    Dim wsDest As Worksheet
    Dim targetDay As Date, searchValueDate As Date
    Dim lastDataRow As Long, lastRow As Long
    Dim i As Long, maxCol As Long
    Dim inputCol As Long, prodCol As Long
    Dim foundProdCol As Boolean, foundInputCol As Boolean
    Dim inputProcessedTotal As Double
    Dim dictProducts As Object
    Dim prod As Variant, joinedProducts As String
    Dim sheetName As String
    
    ' ==== inisialisasi ====
    targetDay = Date - 1
    searchValueDate = targetDay
    sheetName = Format(searchValueDate, "dd")
    Set dictProducts = CreateObject("Scripting.Dictionary")
    
    ' ==== ambil file lampiran ====
    tempFile = GetAttachment_FillingGly(searchValueDate)
    If tempFile = "" Then
        MsgBox "File Filling Glycerine tidak ditemukan.", vbExclamation
        Exit Sub
    End If
    
    ' ==== buka excel sumber ====
    Set xlApp = CreateObject("Excel.Application")
    xlApp.Visible = False
    Set xlWb = xlApp.Workbooks.Open(tempFile, ReadOnly:=True)
    
    ' ==== buat worksheet tujuan (setelah file valid) ====
    On Error Resume Next
    Set wsDest = ThisWorkbook.Sheets(sheetName)
    If wsDest Is Nothing Then
        Set wsDest = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
        wsDest.Name = sheetName
    End If
    On Error GoTo ErrHandler
    
    ' ==== loop sheet sumber ====
    For Each xlWs In xlWb.Sheets
        If InStr(1, LCase(xlWs.Name), "daily report", vbTextCompare) > 0 Then
            inputProcessedTotal = 0
            Set dictProducts = CreateObject("Scripting.Dictionary")
            foundInputCol = False: foundProdCol = False
            
            ' batas kolom dan baris
            maxCol = xlWs.Cells(7, xlWs.Columns.Count).End(xlToLeft).Column
            lastDataRow = xlWs.Cells(xlWs.Rows.Count, 1).End(xlUp).Row
            
            ' cari kolom
            For i = 1 To maxCol
                If xlWs.Cells(9, i).Value <> "" Then
                    If xlWs.Cells(9, i).MergeArea.Cells(1, 1).Value = "PRODUCT" Then
                        prodCol = i: foundProdCol = True
                    End If
                End If
                
                If xlWs.Cells(7, i).Value <> "" And xlWs.Cells(10, i).Value <> "" Then
                    If xlWs.Cells(7, i).MergeArea.Cells(1, 1).Value = "ACTUAL FINISH PRODUCT " And _
                       xlWs.Cells(10, i).Value = "TOTAL ACTUAL" Then
                        inputCol = i: foundInputCol = True
                    End If
                End If
            Next i
            
   'tesssss
           For i = 10 To lastRow
            If ws.Cells(i, 1).MergeCells Then
                mergeVal = ws.Cells(i, 1).MergeArea.Cells(1, 1).Value
            Else
                mergeVal = ws.Cells(i, 1).Value
            End If
    
            If mergeVal = targetDay Then
                If isEndOfMonth Then
                    If i >= 150 Then
                        matchingRows.Add i
                    End If
                Else
                    matchingRows.Add i
                End If
            End If
        Next i
    
        If matchingRows.Count = 0 Then
            wsTarget.Cells(Row, 1).Value = plantLabel & " - Tanggal tidak ditemukan"
            Row = Row + 2
            wb.Close False
            Exit Sub
        End If
            
            
            For Each r In matchingRows
            Dim finishProduct As Double
                finishProduct = GetCellVal(ws, CLng(r), "ACTUAL FINISH PRODUCT", "TOTAL ACTUAL", 7, 10)
            Next r
            
           With wsTarget
            .Cells(Row, 1).Value = plantLabel
            Row = Row + 1
    
            If finishProduct > 0 Then
                .Cells(Row, 1).Value = "Quantity": Row = Row + 1
                .Cells(Row, 1).Value = "RBDPO Process : " & Round(rbdpoKg / 1000, 0) & " MT": Row = Row + 1
                .Cells(Row, 1).Value = "Olein : " & Round(oleinKg / 1000, 0) & " MT (" & Format(oleinKg / rbdpoKg * 100, "0.00") & " %)": Row = Row + 1
                .Cells(Row, 1).Value = "Stearin : " & Round(stearinKg / 1000, 0) & " MT (" & Format(stearinKg / rbdpoKg * 100, "0.00") & " %)": Row = Row + 1
                .Cells(Row, 1).Value = "Steam : " & Format(weightedSteam / rbdpoKg, "0.00") & " kg/MT": Row = Row + 1
                .Cells(Row, 1).Value = "Elect : " & Format(weightedElectricity / rbdpoKg, "0.00") & " kwh/MT": Row = Row + 1
                .Cells(Row, 1).Value = "Water : " & Format(weightedWater / rbdpoKg, "0.00") & " m3/MT RBDPO": Row = Row + 1
            End If
    
            ' Tulis downtime (selalu tulis, meskipun RBDPO=0)
            If downtimeText <> "" Then
                .Cells(Row, 1).Value = downtimeText
                Row = Row + 1
            End If
    
            Row = Row + 1
        End With
End Sub


